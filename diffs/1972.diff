--- perf_takehome.py	2026-01-21 01:15:07
+++ solution_new.py	2026-01-21 01:14:51
@@ -209,7 +209,7 @@
         buffers = []
         vector_batch = (batch_size // VLEN) * VLEN
         vector_blocks = vector_batch // VLEN
-        pipe_buffers = min(12, vector_blocks) if vector_blocks else 0
+        pipe_buffers = min(18, vector_blocks) if vector_blocks else 0
         for bi in range(pipe_buffers):
             buffers.append({
                 "idx": self.alloc_scratch(f"idx_v{bi}", VLEN),
@@ -399,7 +399,7 @@
                     elif phase == "round1_select":
                         valu_tasks.append((6, 2, block, "round1_select"))  # combined: offset + node
                     elif phase == "round2_select1":
-                        valu_tasks.append((6, 1, block, "round2_select1"))  # offset = idx - 3
+                        valu_tasks.append((6, 1, block, "round2_select1"))  # offset
                     elif phase == "round2_select2":
                         valu_tasks.append((6, 2, block, "round2_select2"))  # sel0, sel1
                     elif phase == "round2_select3":
@@ -411,7 +411,7 @@
                     elif phase == "round3_select1":
                         valu_tasks.append((6, 1, block, "round3_select1"))  # offset = idx - 7
                     elif phase == "round3_select2":
-                        valu_tasks.append((6, 3, block, "round3_select2"))  # sel0, sel1*2, sel2
+                        valu_tasks.append((6, 3, block, "round3_select2"))  # sel0, sel1, sel2
                     elif phase == "round3_select3":
                         valu_tasks.append((6, 3, block, "round3_select3"))  # sel1, t01, t23
                     elif phase == "round3_select4a":
@@ -499,19 +499,18 @@
                         valu_ops.append(("multiply_add", buf["node"], diff_1_2_v, buf["tmp1"], tree1_v))
                         block["next_phase"] = "xor"
                     elif phase == "round2_select1":
-                        # Round 2: idx in {3,4,5,6}, compute offset = idx - 3
+                        # Round 2: compute offset = idx - 3
                         valu_ops.append(("-", buf["tmp1"], buf["idx"], three_v))
                         block["next_phase"] = "round2_select2"
                     elif phase == "round2_select2":
-                        # Compute sel0 = offset & 1, sel1 = offset >> 1 (no RAW hazard)
+                        # Compute sel0 = offset & 1, sel1 = offset >> 1
                         valu_ops.append(("&", buf["tmp2"], buf["tmp1"], one_v))   # sel0
                         valu_ops.append((">>", buf["cond"], buf["tmp1"], one_v))  # sel1
                         block["next_phase"] = "round2_select3"
                     elif phase == "round2_select3":
                         # Compute low and high using linear interpolation
-                        # low = tree3 + sel0 * diff_3_4, high = tree5 + sel0 * diff_5_6
                         valu_ops.append(("multiply_add", buf["tmp1"], diff_3_4_v, buf["tmp2"], tree3_v))  # low
-                        valu_ops.append(("multiply_add", buf["node"], diff_5_6_v, buf["tmp2"], tree5_v))  # high (temp in node)
+                        valu_ops.append(("multiply_add", buf["node"], diff_5_6_v, buf["tmp2"], tree5_v))  # high
                         block["next_phase"] = "round2_select4"
                     elif phase == "round2_select4":
                         # Compute diff = high - low
